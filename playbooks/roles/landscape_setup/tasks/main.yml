---
# Ensure system is attached to Ubuntu Pro
- name: Attach to Ubuntu Pro
  ansible.builtin.command: "pro attach {{ lookup('env', 'UBUNTU_PRO_TOKEN') }}"
  register: result
  failed_when: result.rc not in [0, 2]
  changed_when: result.rc not in [0, 2]
  tags: [ubuntu_pro]

# Check if Landscape config file exists
- name: Check if /etc/landscape/client.conf exists
  ansible.builtin.stat:
    path: /etc/landscape/client.conf
  register: landscape_conf

# Enable Landscape if config file does not exist
- name: Enable Landscape silently
  ansible.builtin.command: >
    pro enable landscape --silent --account-name {{ lookup('env', 'LANDSCAPE_ACCOUNT_NAME') }}
  when: not landscape_conf.stat.exists
  tags: [landscape]

# Ensure landscape-client is installed
- name: Ensure landscape-client is installed
  ansible.builtin.apt:
    name: landscape-client
    state: present
    update_cache: yes
  tags: [landscape]

# Deploy Landscape config file
- name: Deploy Landscape config file
  ansible.builtin.copy:
    src: client.conf
    dest: /etc/landscape/client.conf
    owner: root
    group: root
    mode: '0644'
  tags: [landscape]

# Ensure landscape-client service is enabled and running
- name: Ensure landscape-client service is enabled and running
  ansible.builtin.service:
    name: landscape-client
    state: started
    enabled: yes
  tags: [landscape]
